## https加密流程
本篇简称浏览器为 B，服务器为 S，证书厂商为 CA

#### 对称加密
- 相对于http的明文裸奔，对称加密是用一个对称密钥，B 用对称密钥加密，C 收到消息体用这个对称密钥解密
- 优点：算法公开、计算量小、加密速度快、加密效率高
- 但是这种方式对称加密秘钥也会被拦截，也不够安全，进而还是存在被中间人攻击风险

#### 非对称加密
- 非对称加密其实就是用公钥加密，用私钥解密
- 缺点：加密和解密花费时间长、速度慢，只适合对少量数据进行加密
- B 请求 S，S返回自己的公钥，B 拿到 S 的公钥后用他加密一串对称密钥key，然后把加密后的对称密钥key1发给 S，S 收到key1之后用自己的私钥解密这段key1得到真正的对称密钥key，之后的请求报文就全用这段对称密钥key进行加密。这个过程其实就是安全交换对称密钥
- 但是，也存在一种安全性，比如 Charles/Fiddler 是怎么抓包 https 的

#### Charles/Fiddler 是怎么抓包 https
- Charles 作为中间人，B 请求 S，S 返回公钥的时候被Charles拦截了，然后Charles将自己的公钥发给 B
- B 并不知道这不是 S 原本的公钥，B 依旧就这个公约加密了对称密钥key得到key1
- Charles 拿到 B 发来key1，用自己的私钥解密得到对称密钥key
- Charles 用之前 S 返回的公钥加密对称密钥key得到加密后的对称密钥key2发给 S
- S 接收到key2，S 用自己的私钥解密key2得到对称密钥key
- 之后 B 和 S 所有的请求都用对称密钥key加密，但是Charles也有这段key，所以Charles可以解码出所有的密文
- 解决这种中间人隐患的方法: 权威的证书颁发机构CA来解决。由于Charles给 B 的证书不受信任会被浏览器警告，所以我们用Charles抓https包之前需要安装Charles的证书并信任它。

#### CA 认证流程
- 制作证书流程:
  - S 将自己的公钥发给 CA 申请证书
  - CA 有自己的公私钥，CA 用上级 CA 的私钥加密 S 的公钥，并通过 S 的域名等信息生成一个签名，也用自己的私钥加密
  - 证书制作完成后，CA 将证书发给 S
- 校验证书:
  - B 请求 S 的时候，S 不再直接返回自己的公钥，而是把证书返回给 B
  - B 验证证书的有效性:
    - 1. 验证证书是否在有效期内
    - 2. 验证证书是否是上级CA签发的，上级还有上级，最终是根证书。各大浏览器和操作系统都维护了所有权威CA的根证书。
    - 3. 验证证书是否被吊销了,黑名单方式定期向CA拉取吊销的证书，或者OCSP实时连接CA认证
    - 4. 用上级 CA 的公钥解密签名，然后用同样的方式也生成签名，对比签名一直则认证通过
- 校验通过后，B 用根证书的私钥解密证书里 S 的公钥
- 接下来就是之前的流程了，用从证书里解密出来的 S 公钥加密一串对称密钥给 S，S 用私钥解密出key之后报文就全部用key进项对称加密
- CA 认证主要就是避免 S 直接将自己的公钥给 B 的时候被拦截，而是通过将公钥给 CA 这个受信任的中间人，B 从 CA 处获取 S 的公钥
- 为什么 Charles 需要先安装证书，就是为了在系统里有了根证书，在检验证书有效性的时候可以用这个根证书验证与解密，而正规的 CA 厂商们的证书已经被各个系统内置了，所以不用像 Charles 那样使用前还得手动安装