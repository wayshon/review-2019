## 项目经验

### 总结一下垃圾分类的亮点
- 小程序
  - 设计主体功能，文字，语音，拍照查询。小测试与落地页引导分享
- 服务端
  - express 搭建服务端，docker跑pm2， mongodb，redis，nginx 设置 http2 并均衡负载
  - 调用百度ocr与腾讯语音识别
  - 爬虫上海发布公众号，并入库mongodb
  - 模糊搜索
  - redis节流缓存查询
  - 加密请求头字段，防止爬虫。请求头定义一个字段，aes加密当前字段，服务端解密字段，间隔大于30秒就驳回请求。并且限制ip存redis周期设置1分钟60次，首页列表查询的内容返回体也做加密，防止charles抓包一次型抓了大量数据。由于小程序是入包的，所以不担心aes密钥泄露问题
- 成效:峰值单日10万UV，60万PV

### 总结一下自己封装的react
- 老框架存在的问题:
  - 使用zepto，没有mvvm开发体验好。
  - npm 不能用，老的js引入方式版本管理不方便
  - 与 .net 站点强耦合，由于是写 cshtml，前端很多功能受限，比如路由和状态管理
- 优势:
  - react 组件化开发，mvvm 解耦
  - node 站点前端可控，可以接入配置中心和日志系统
  - 重新编写打包任务，做到一次打包一次发布，四端运行
- 技术难点:
  - 抽离公共代码与业务组建，分别封装携程基础代码/去哪儿基础代码，暴露统一输入输出。两侧的node渲染script的时候根分别引用不同的基础库，暴露同名的全局变量。webpack里配置external，业务代码引入此变量。
  - spa 代替多页面导致首屏加载变慢，解决办法:
    - webpack 分片打包
    - node渲染字符串时除了当前请求的js，其他js加上prefetch
    - 静态资源放CDN，并且域名不同不会导致带上主域的cookie占用请求大小
    - html感官loading，js deffer加载
    - 实际效果，多页时候 6.3, spa 优化前 9.1，优化后 5.9, 最大的vender.js由 300k 缩小到 50K+
  - 组件的展示:
    - 定义了一个容器页面，此页面根据url参数判断渲染组件库里的哪个组件，目的是在app里打开新的webview并传入组件名，由容器页面渲染对应的组件，避免组件库每添加一个组件就在业务代码里定义路由。
    - 在基础类里面封装了传值和页面返回时取回调，磨平了携程与去哪儿两端的差异，业务代码只需要监听对应的事件。传值的时候根据参数大小选择url拼接或者localStorage传
    - h5 端使用modal弹窗的形式展示组件，不发生跳转。
  - 埋点统计
    - 监听document冒泡事件，由于react的事件有自己的事件分发中心，就算react事件里阻止冒泡，原生事件只要不显示阻止还是会冒泡
    - 监听了事件类型，xpath，select，元素参数和页面id等
  - 封装基础类:
    - 利用高阶函数反向继承，接收组件作为参数，生成一个类继承这个组件，为的是获取到组件的pageid然后统一在对应的生命周期内埋点，而不用组件自己在各个声明周期重复埋点
    - 封装唤起页面级组件的传值与回调
    - 注入埋点方法登公共方法
- 成效: 替代了老的开发框架，战胜了另一个在老的基础上部分dom挂在vue并且两次打包的方案，稳定运行国内包车的几个产品线。

### 总结一下即刻出行的亮点
- 背景，bu要自己的打车app，但是公共还没有独立APP的sdk
- 技术难点:
- 从携程主app的iOS代码，拿出登录，支付，热更新，hybrid webview与RN等公用模块
- 修改登录模块，暴露RN模块，使用RN开发页面，调用 oc 模块
- 修改地图组件，如使用UIView实现Marker的平滑移动；获取图商的定位，因为iOS的定位方法获取到的是国际经纬度标准，MapKit的定位是中国的加密转换后的火星经纬度
- 集成推送模块，公共没有成型的推送模块。
  - 集成极光sdk，CRN的目录结构与RN不一样，导致react-native link不被办法用，需要手动集成依赖
  - ios:
    - 杀死app的情况下delegate获取到的参数notification给viewController, 拼接rn bundle url后面启动 RNRootView，RN获取启动参数
    - app 活着的情况下将获取的到push数据通过事件发送，在 RN 代码里监听事件
  - 安卓:
    - app杀死的情况下在splash获取push数据，并跳转主activity，拼接参数打开rn bundle url
    - app活着的情况与iOS一样
- 成效: 截止2018年app用户数7.2万，崩溃率千分之1.6